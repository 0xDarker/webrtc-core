#!/usr/bin/groovy

// Node label
// Find more info about these:
// https://engit.cisco.com/build/cloudbees-jenkins/documentation-central-jenkins-build-agents
pipeline {
  agent any

  tools {nodejs "Node v14"}

  options {
    ansiColor('xterm')
  }
  environment {
    GH_CRED = credentials('github_creds')
  }

  stages {
    stage('Prerequisite Check') {
      steps {
        sh 'node -v'
        sh 'npm -v'
        sh 'npm install yarn'
        sh 'pwd'
        echo " current workspace ${env.WORKSPACE}"
      }
    }
    stage('Install dependencies') {
      steps {
        sh './node_modules/yarn/bin/yarn install'
      }
    }
    stage('Validate Lint') {
      steps {
        // Validate lint
        sh './node_modules/yarn/bin/yarn test:lint'
        //@TODO: handle lint errors (fail build??)
      }
    }
    stage('Run unit test') {
      steps {
        sh './node_modules/yarn/bin/yarn test:coverage'
        publishHTML([
          allowMissing: false,
          alwaysLinkToLastBuild: false,
          keepAll: true,
          reportDir: 'coverage',
          reportFiles: 'index.html',
          reportName: 'Jest Coverage Report',
          reportTitles: 'All Tests'
        ])
        publishCoverage adapters:
          [istanbulCoberturaAdapter('coverage/cobertura-coverage.xml')],
          calculateDiffForChangeRequests: true,
          failBuildIfCoverageDecreasedInChangeRequest: true,
          sourceFileResolver: sourceFiles('NEVER_STORE')
      }
    }
    stage('Build package') {
      steps {
        sh './node_modules/yarn/bin/yarn build'
      }
    }
    stage('Publish release') {
      steps {
        script  {
          sh 'git remote set-url origin "https://$GH_CRED@sqbu-github.cisco.com/CPaaS/webrtc-core.git"'
            if (env.BRANCH_NAME == "master") {
              sh 'echo "_auth=$NPM_ARTIFACTORY_TOKEN" >> ~/.npmrc'
              sh 'echo "always-auth=true" >> ~/.npmrc'
              sh 'echo "email=$NPM_ARTIFACTORY_EMAIL" >> ~/.npmrc'
              echo 'Publishing to npm artifactory and creating release'
              sh './node_modules/yarn/bin/yarn release'
            } else {
              echo "Skipping publish - This build is not occurring on a publish-able branch!"
              echo "Release dry run!"
              sh './node_modules/yarn/bin/yarn release -- --dry-run'
            }
        }
      }
    }
  }
}
