#!/usr/bin/groovy

// Node label
// Find more info about these:
// https://engit.cisco.com/build/cloudbees-jenkins/documentation-central-jenkins-build-agents
def NODE_LABEL = 'docker'
def DOCKER_REGISTRY = '527856644868.dkr.ecr.us-east-2.amazonaws.com'
def DOCKER_REPO = 'cpaas'
def DOCKER_IMAGE = 'webrtc-core'
def DOCKER_TEST_IMAGE = 'webrtc-core-test'
def DOCKER_TAG  // Computed later
def AWS_CREDS_ID = 'ecr:us-east-2:cpaas-aws-creds' // this uses cpaas-aws-creds from Jenkins

pipeline {
  agent any

  tools {nodejs "Node v14"}

  stages {
    stage('Pre Check Git') {
      steps {
        sh 'node -v'
        sh 'npm -v'
        sh 'pwd'
      }
    }
    stage('Install dependencies') {
      steps {
        sh 'npm install'
      }
    }
    stage('Run test') {
      steps {
        sh 'npm test'

        publishHTML([allowMissing: false,
                     alwaysLinkToLastBuild: false,
                     keepAll: true,
                     reportDir: 'coverage/lcov-report',
                     reportFiles: 'index.html',
                     reportName: 'HTML Report',
                     reportTitles: 'All Tests'])
      }
    }
    stage('Build package') {
      steps {
        sh 'npm run build'
      }
    }
  }
}
